var _form={valid:function(c){var d=true;$(c).find("small").each(function(){if($(this).attr("data-bv-result")=="INVALID"){d=false}});return d}};$.extend({comment:{detailKey:"comment-detail",sid:0,_commentDetailModal:"",_detailForm:"",_detailFormBtn:"",_closeBtn:"",_commentPid:"",_commentPlace:"",_commentPost:"",_cancelReply:"",_commentReply:"",_simplemde:null,initDom:function(){$.comment._commentDetailModal=$("#comment-detail-modal");$.comment._detailForm=$("#detail-form");$.comment._detailFormBtn=$("#detail-form-btn");$.comment._closeBtn=$("#comment-detail-modal .close");$.comment._commentPid=$("#comment-pid");$.comment._commentPlace=$("#comment-place");$.comment._commentPost=$("#comment-post");$.comment._cancelReply=$("#cancel-reply");$.comment._commentReply=$(".comment-reply")},init:function(g){var f=$("#comment-box");if(!f||!f[0]){return}var e=$.extend({},g);var h='<div id="comment-place"><div class="comment-post" id="comment-post" style="position: relative"><h4 class="bottom-line"><i class="fa fa-commenting-o fa-fw icon"></i><strong>评论</strong></h4><form class="form-horizontal" role="form" id="comment-form"><div class="cancel-reply" id="cancel-reply" style="display: none;"><a href="javascript:void(0);" onclick="$.comment.cancelReply(this)" rel="external nofollow"><i class="fa fa-share"></i>取消回复</a></div><input type="hidden" name="pid" id="comment-pid" value="0" size="22" tabindex="1"><textarea id="comment_content" class="form-control col-md-7 col-xs-12 valid" style="display: none"></textarea><textarea name="content" style="display: none"></textarea><div style="position: absolute;right: 10px;bottom: 70px;font-size: 14px;font-weight: 700;color: #ececec;z-index: 1;">张亚东博客<br>https://www.zhyd.me<br>讲文明、要和谐</div><a id="comment-form-btn" type="button" data-loading-text="正在提交评论..." class="btn btn-default btn-block">提交评论</a></form></div></div>';f.html(h);$.comment.initDom();this._simplemde=$.comment.createEdit(e);$.comment.loadCommentList(f);$.comment.initValidatorPlugin()},createEdit:function(c){console.log(c.menu);var d=new SimpleMDE({element:document.getElementById("comment_content"),toolbar:["bold","italic","|","code","quote","|","preview","|","guide"],autoDownloadFontAwesome:false,placeholder:"说点什么吧",renderingConfig:{codeSyntaxHighlighting:true},tabSize:4});d.codemirror.on("change",function(){$("textarea[name=content]").val(d.markdown(d.value()))});return d},loadCommentList:function(e,f){var d=e.attr("data-id");if(!d){throw"未指定sid！"}this.sid=d;$.ajax({type:"get",url:"/article/comments",data:{sid:d,pageNumber:f||1},success:function(i){$.alert.ajaxSuccess(i);var r=i.data.commentList;var s="";if(!r){s='<div class="commentList"><h4 class="bottom-line"><i class="fa fa-comments-o fa-fw icon"></i><strong><em>0</em> 条评论</strong></h4><ul class="comment">';s+='<li><div class="list-comment-empty-w fade-in"><div class="empty-prompt-w"><span class="prompt-null-w">还没有评论，快来抢沙发吧！</span></div></div></li>';s+="</ul></div>";$(s).appendTo(e)}else{if(!f){s='<div class="commentList"><h4 class="bottom-line"><i class="fa fa-comments-o fa-fw icon"></i><strong><em>'+i.data.total+'</em> 条评论</strong></h4><ul class="comment">'}for(var a=0,q=r.length;a<q;a++){var t=r[a];var b=t.url||"javascript:void(0)";var o=t.parent;var c="";if(t.admin){c='<img src="/img/author.png" alt="" class="author-icon" title="管理员">'}var p=o?'<a href="#comment-'+o.id+'" class="comment-quote">@'+o.nickname+'</a><div style="background-color: #f5f5f5;padding: 5px;margin: 5px;border-radius: 4px;"><i class="fa fa-quote-left"></i><p></p><div style="padding-left: 10px;">'+filterXSS(o.content)+"</div></div>":"";s+='<li>    <div class="comment-body fade-in" id="comment-'+t.id+'">        <div class="cheader">           <div class="user-img">'+c+'<img class="userImage" src="'+filterXSS(t.avatar)+'" onerror="this.src=\''+appConfig.staticPath+'/img/user.png\'"></div>           <div class="user-info">              <div class="nickname">                 <a target="_blank" href="'+b+'" rel="external nofollow"><strong>'+t.nickname+'</strong></a>              </div>                         <div class="timer">                  <i class="fa fa-clock-o fa-fw"></i>'+t.createTimeString+'              </div>          </div>        </div>        <div class="content">'+p+"<div>"+filterXSS(t.content)+'</div></div>        <div class="sign">            <a href="javascript:void(0);" class="comment-up" onclick="$.comment.praise('+t.id+', this)"><i class="fa fa-thumbs-o-up"></i>赞(<span class="count">'+t.support+'</span>)<i class="sepa"></i></a>            <a href="javascript:void(0);" class="comment-down" onclick="$.comment.step('+t.id+', this)"><i class="fa fa-thumbs-o-down"></i>踩(<span class="count">'+t.oppose+'</span>)<i class="sepa"></i></a>            <a href="javascript:void(0);" class="comment-reply" onclick="$.comment.reply('+t.id+', this)"><i class="fa fa-reply"></i>回复</a>            <a href="javascript:void(0);" class="comment-flag hide" onclick="$.comment.report('+t.id+', this)"><i class="fa fa-flag"></i>举报</a>        </div>    </div></li>'}if(i.data.hasNextPage){s+='<li><div class="list-comment-empty-w fade-in"><div class="empty-prompt-w"><span class="prompt-null-w pointer load-more">加载更多 <i class="fa fa-angle-double-down"></i></span></div></div></li>'}if(!f){s+="</ul></div>";$(s).appendTo(e)}else{$(s).appendTo($(".comment"))}$(".load-more").click(function(){$(this).parents("li").hide();$.comment.loadCommentList(e,i.data.nextPage)})}},error:$.alert.ajaxError})},initValidatorPlugin:function(){$.comment._detailForm.bootstrapValidator({message:"输入值无效",feedbackIcons:{valid:"fa fa-check",invalid:"fa fa-remove",validating:"fa fa-refresh"},fields:{nickname:{validators:{notEmpty:{message:"昵称必填"}}},url:{validators:{uri:{message:"URL地址不正确"}}},email:{validators:{emailAddress:{message:"邮箱地址不正确"}}}}})},submit:function(m){var n=$(m);n.button("loading");var j=localStorage.getItem(this.detailKey);var i=$("#comment-form").serialize();if(!j){}else{var h=$.tool.parseFormSerialize(j);$.comment._detailForm.find("input").each(function(){var a=$(this);var b=a.attr("name");if(h[b]){a.val(h[b])}});var k=$.comment._detailForm.find("img");k.attr("src",h.avatar);k.removeClass("hide")}this._commentDetailModal.modal("show");this._closeBtn.unbind("click");this._closeBtn.click(function(){setTimeout(function(){n.html("<i class='fa fa-close'></i>取消操作...");setTimeout(function(){n.button("reset")},1000)},500)});this._commentDetailModal.find(".modal-content").addClass("shake");$.comment._detailForm.find("input[name=qq]").unbind("change");$.comment._detailForm.find("input[name=qq]").change(function(){var b=$(this);var a=b.val();var c=b.next("img");if(a){$.ajax({type:"post",url:"/api/qq/"+a,success:function(e){$.alert.ajaxSuccess(e);var d=e.data;$.comment._detailForm.find("input").each(function(){var f=$(this);var g=f.attr("name");if(d[g]){f.val(d[g])}});c.attr("src",d.avatar);c.removeClass("hide")},error:$.alert.ajaxError})}else{c.addClass("hide")}});this._detailFormBtn.unbind("click");this._detailFormBtn.click(function(){$.comment._detailForm.bootstrapValidator("validate");if(_form.valid($.comment._detailForm)){i=i+"&"+$.comment._detailForm.serialize();localStorage.setItem($.comment.detailKey,$.comment._detailForm.serialize());l(i)}});function l(a){console.log(a);$.ajax({type:"post",url:"/article/comment",data:a+"&sid="+$.comment.sid,success:function(b){$.alert.ajaxSuccess(b.message);$.comment._commentDetailModal.modal("hide");setTimeout(function(){n.html("<i class='fa fa-check'></i>"+b.message);setTimeout(function(){n.button("reset");window.location.reload()},3000)},1000)},error:function(b){$.alert.ajaxError();n.button("reset")}})}},reply:function(d,c){this._commentPid.val(d);this._cancelReply.show();$(c).hide();$(c).parents(".comment-body").append($("#comment-form"))},cancelReply:function(b){this._commentPid.val("");this._cancelReply.hide();$(b).parents(".comment-body").find(".comment-reply").show();this._commentPost.append($("#comment-form"))},praise:function(d,c){$.bubble.unbind();$.ajax({type:"post",url:"/api/doSupport/"+d,success:function(a){$.alert.ajaxSuccess(a);if(a.status==200){$(c).effectBubble({y:-80,className:"thumb-bubble",fontSize:1,content:'<i class="fa fa-smile-o"></i>+1'});var b=$(c).find("span.count").text();$(c).find("span.count").text(parseInt(b)+1)}$.bubble.init()},error:function(){$.alert.ajaxError();$.bubble.init()}})},step:function(d,c){$.bubble.unbind();$.ajax({type:"post",url:"/api/doOppose/"+d,success:function(a){$.alert.ajaxSuccess(a);if(a.status==200){$(c).effectBubble({y:-80,className:"thumb-bubble",fontSize:1,content:'<i class="fa fa-meh-o"></i>+1'});var b=$(c).find("span.count").text();$(c).find("span.count").text(parseInt(b)+1)}$.bubble.init()},error:function(){$.alert.ajaxError();$.bubble.init()}})},report:function(d,c){}}});$(function(){$.comment.init({customMenu:true});$("#comment-form-btn").click(function(){$.comment.submit($(this))})});